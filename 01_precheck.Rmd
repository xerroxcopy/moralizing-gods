# Precheck

Make sure to use a full `polities.csv` file (if you re-run using the output the multiple imputation loop will run into bugs when it comes across NGAs with only one polity)

NB: Using shortened variables.csv file that only uses variables of interest to save computational time. If using full file, may need to renumber variables in Aggr.MI

**Don't rerun this section unless it's a new scrape**
  

# Checks Soc Complx data from exportdat.csv for error

The variable `polities` was used all over the code. MM changed the variable name to `polities_pre` for pre-checked, pre-tidied version in order to distinguish it with the one used for analysis. 

```{r}
polities_raw <- read_csv("inpput/polities.csv")
```

### Quick look at the raw data

```{r polities-quick-plot}
polities_raw %>% 
  transform(Complexity  = factor(Complexity, levels = c("Early", "Medium", "Late"))) %>% 
  ggplot(aes(x = NGA, ymin = Start, y = (Start + End) / 2, ymax = End, colour = Complexity)) +
  geom_errorbar(width = 0.3) +
  geom_text(aes(label = PolName, size = abs(End - Start)), colour = "Black", vjust = -0.1, show.legend = FALSE) + # angle = 90
  scale_size_continuous(range = c(0, 3)) +
  scale_colour_viridis_d() +
  coord_flip()

```

### delete duplicated entries 

Not sure why Dupl is deleted.

```{r}


polities_pre <- polities_raw %>% 
  filter(Dupl == "n")
```

### Vars


`Vars` is a 225 row variables of complexity suchas population, professional soldiers etc.

```{r}
Vars_old <- as.matrix(read.csv('input/variables.csv', header=TRUE))

Vars <- read_csv("input/variables.csv") %>% # originally as.matrix()
  mutate(Variable = paste(Subsection, Variable)) # Creating unique variable/section combinations
# Vars[,1] <- paste(Vars[,2],Vars[,1]) 
```


## dat nad filtering it into SCdat

`dat` seems to be a matrix that contain nearly 40k entries of changes in social complexity on variables such as ...wakaran! 
Not sure why matrix is used for `dat`. 
At first glance, `SCdat` seems to be a modified `dat` which is generated by filtering its `Variables` by `Vars`'s `Variables`. 
After that, it seems that scdat filters for the Polity that matches with `polities`'s PolID.
Is this correct??
The nrow() of the `dat` should shrink down to 25813 then 21025. Almost all `Comments` are NA. 34 rows are either "warning - Surrounding a simple value in uncertain brackets" or "The fact is uncertain" 

```{r}
# dat_old <- read.table('input/exportdat.csv', sep=",", header=TRUE, quote = "", colClasses = "character")
dat <- 
  read_csv("input/exportdat.csv", col_types = cols(`Value To` = col_character())) %>%  # without col_types, returns parsing failures on row 5342, 18249, 18750. maybe col_double is more suitable? DUNNO
  filter(Section %in% c("Social Complexity variables",  "Ritual variables", "Religion and Normative Ideology"))  %>%   # Section is set in !MI.R
  mutate(Variable = paste(Subsection, Variable))  %>% # ISSUE: str_c does not work: "a" + NA = NA. 
  filter(Variable %in% Vars$Variable) %T>% {print(dim(.))} %>%  
  filter(Polity %in% polities$PolID) %T>% {print(dim(.))} %>% 
  select(-Section, -Subsection, -Comment)

row.names(dat) <- NULL # at the first glance i dunno why we need this... we'll get back to this ISSUE
# nrow(SCdat) - sum(is.na(SCdat$Comment))
```


### Recoding

```{r}
#inspect first
dat$`Value From` %>%  unique() # not applicable and not applicalbe....? ISSUE
dat$`Value To` %>%  unique() # mostly integers and NAs, 3 should be double...? idk. no characters it seems.
dat %>% filter(`Value From` == "present absent")

```


Convert categorical values to numbers. Ignore warnings: they will be taken care off in the next step -- in errors

```{r}
dat_recoded <- dat
dat_recoded$`Value From` <- 
  dat_recoded$`Value From` %>% 
  recode(
    present = "1", 
    `inferred present` = "0.9",
    `present` ="1",   
    `inferred present` ="0.9",   
    `inferred absent` ="0.1",   
    `absent` ="0",   
    `present absent` = "0.5", # this seems to be dropped from the original Nature script, but had to be included. not sure how to code this though. tentatively putting 0.5.
    `none` ="0",
    `daily` ="6",   
    `weekly` ="5",
    `monthly` ="4",  
    `monthly/seasonal` = "3.5", # 3.5 maybe? this seems to be dropped from the original Nature script, but had to be included.
    `seasonally` ="3",  
    `yearly` ="2",   
    `once per generation` ="1",   
    `once in a generation` = "1", # this seems to be dropped from the original Nature script, but had to be included.
    `once in a lifetime` ="0",    
    `whole polity` ="3",      
    `majority` ="2",      
    `substantial minority` ="1",      
    `elites` ="0",          
    `inactive` ="1",
    `active` ="2",          
    `moralizing` ="3",          
    `monotheistic` ="1",     
    `polytheistic` ="2",                                                     
    `not applicable` = NA_character_,      
    `not applicalbe` =  NA_character_,  # this seems to be dropped from the original Nature script, but had to be included.
    `suspected unknown` =  NA_character_,      
    `suspected unknwon` = NA_character_, # this seems to be dropped from the original Nature script, but had to be included.
    `uncoded` = NA_character_, # this seems to be dropped from the original Nature script, but had to be included.
    `unknown` = NA_character_ # https://github.com/tidyverse/dplyr/issues/3202
  )
```

#### inspect

test if there's still character

```{r}

# inspect old
dat$`Value From` %>% 
str_detect(letters) %>% sum() # 5096 rows contain letters.
dat$`Value To` %>% 
str_detect(letters) %>% sum() # NA

# inspect new
dat_recoded$`Value From` %>% 
str_detect(letters) %>% sum() # NA

dat_recoded$`Value To` %>% 
  str_detect(letters) %>% sum() # NA

```
none.

```{r}
dat_recoded2 <- dat_recoded %>%
  mutate(`Value From` = as.numeric(as.character(dat_recoded$`Value From`)),
         `Value To` = as.numeric(as.character(dat_recoded$`Value To`))) %>%  # NAs introduced during coersion something... maybe it's okay?
  drop_na(`Value From`)

dat_recoded2 %>% 
  filter(`Value To` == "")
```

```{r}

SCdat <- SCdat[is.na(dat[,4])==FALSE,]
dat <- SCdat[SCdat[,5]!="",]
datNA <- dat
for(i in 1:nrow(dat)){
   datNA[i,5] <- as.numeric(dat[i,5])
}
errors <- rbind(errors,dat[is.na(datNA[,5]),])

# Change BCE to negative years and remove CE. 
for(i in 1:nrow(SCdat)){
   if(substr(SCdat[i,6], (nchar(SCdat[i,6]) - 2) , nchar(SCdat[i,6]) ) =="BCE" )
   {a <- -as.numeric(substr(SCdat[i,6], 1, (nchar(SCdat[i,6]) - 3)))
    SCdat[i,6] <- a}
   if(substr(SCdat[i,7], (nchar(SCdat[i,7]) - 2) , nchar(SCdat[i,7]) ) =="BCE" )
   {a <- -as.numeric(substr(SCdat[i,7], 1, (nchar(SCdat[i,7]) - 3)))
    SCdat[i,7] <- a}
}
for(i in 1:nrow(SCdat)){
   if(substr(SCdat[i,6], (nchar(SCdat[i,6]) - 1) , nchar(SCdat[i,6]) ) =="CE" )
   {a <- as.numeric(substr(SCdat[i,6], 1, (nchar(SCdat[i,6]) - 2)))
    SCdat[i,6] <- a}
   if(substr(SCdat[i,7], (nchar(SCdat[i,7]) - 1) , nchar(SCdat[i,7]) ) =="CE" )
   {a <- as.numeric(substr(SCdat[i,7], 1, (nchar(SCdat[i,7]) - 2)))
    SCdat[i,7] <- a}
}

dat <- SCdat[SCdat[,6]!="",]
for(i in 1:nrow(dat)){
   dat[i,6] <- as.numeric(dat[i,6])
}
errors <- rbind(errors,dat[is.na(dat[,6]),])

dat <- SCdat[SCdat[,7]!="",]
for(i in 1:nrow(dat)){
   dat[i,7] <- as.numeric(dat[i,7])
}
errors <- rbind(errors,dat[is.na(dat[,7]),])

write.csv(errors, file="errors.csv",  row.names=FALSE)
write.csv(SCdat, file="SCdat.csv",  row.names=FALSE)
old_SCdat_final <- read_csv("SCdat.csv")
rm(i,j,var,dat,dt,datNA,a,polities,Vars)

## Checks for polity inclusions
#dat <- read.table('exportdat.csv', sep=",", header=TRUE, quote = "", colClasses = "character")
#dat <- dat[dat$Section==Section,]
#polities_wiki <- levels(as.factor(dat$Polity))
#polities <- read.csv('polities.csv', header=TRUE)
#polities <- polities[polities$Dupl=="n",]
#polities <- levels(as.factor(polities$PolName))

#extras <- vector(length=0)
#for (i in 1:length(polities_wiki)){
#   if(any(polities_wiki[i] == polities)==FALSE){extras <- c(extras, polities_wiki[i])}
#}
#missing <- vector(length=0)
#for (i in 1:length(polities)){
#   if(any(polities[i] == polities_wiki)==FALSE){missing <- c(missing, polities[i])}
#}
#write.csv(extras, file="extras.csv",  row.names=FALSE)
#write.csv(missing, file="missing.csv",  row.names=FALSE)








```
